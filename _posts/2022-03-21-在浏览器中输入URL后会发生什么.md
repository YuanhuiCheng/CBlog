假设这个 URL 是 www.qq.com。

- 浏览器对 URL 进行解析，确定了 Web 服务器和文件名，根据这些信息生成 HTTP 请求信息。
- 发送前，需要查询服务器域名对应的 IP 地址。DNS 服务器专门保存了 WEB 服务器域名与 IP 的对应关系（DNS 域名解析）。
    - 操作系统会先检查自己本地的 __hosts 文件__ 是否有这个网址映射关系。如果有，先调用这个 IP 地址映射，完成域名解析；
    - 如果没有，则查找 __本地 DNS 解析器__ 缓存，是否有这个网址映射关系。如果有，直接返回，完成域名解析；
    - 如果没有，首先会查找 TCP/IP 参数中设置的首选 DNS 服务器（__本地 DNS 服务器__）。当服务器收到查询时，如果要查询的域名包含在本地配置区域资源中则返回解析结果给客户机，完成域名解析。此解析具有权威性；
    - 如果本地 DNS 服务器区域文件与缓存解析都失效，则根据本地 DNS 服务器的设置（是否设置转发器）进行查询。如果 __未用转发模式（迭代查询）__，本地 DNS 就把请求发至 13 台 __根 DNS__。根 DNS 服务器收到请求后会判断这个域名 (.com) 是谁来授权管理，并会返回一个负责该顶级域名服务器的一个 IP。本地 DNS 服务器收到 IP 信息后，将会联系负责 .com 域的这台服务器。这台负责 .com 域的服务器收到请求后，如果自己无法解析，它就会找一个管理 .com 域的下一级 DNS 服务器地址 (qq.com) 给本地 DNS 服务器。当本地 DNS 服务器收到这个地址后，就会找 qq.com 域服务器，重复上面的动作进行查询，直至找到 www.qq.com 主机。
    - 如果用的 __转发模式（递归查询）__，此 DNS 服务器就会把请求转发至上一级 DNS 服务器，由上一级服务器进行解析。上一级服务器如果不能解析，就找根 DNS 或把请求转至上上级，以此循环。最后结果倍返回给本地 DNS 服务器，由此 DNS 服务器再返回给客户机。

    > 根权威服务器 <-> cn (com) 权威（顶级域名）<-> zdns.cn (server.com) (二级域名)
    
    > 递归查询：客户端只发一次请求，要求对方给出最终结果。

    > 迭代查询：客户端发出一次请求，如果对方没有授权回答，它就会返回一个能解答这个查询的其他名称服务器列表。客户端会再向返回的列表中发出请求，直到找到最终负责所查域名的名称服务器，从它得到最终结果。

    > 授权回答：向 DNS 服务器查询一个域名，刚好这个域名是本服务器负责，返回的结果就是授权回答。

    > __从客户端到本地 DNS 服务器是属于递归查询，而 DNS 服务器之间的交互查询就是迭代查询。__

- 通过 DNS 获取到 IP 后，可以把 HTTP 的传输工作交给操作系统中的协议栈。
- 应用程序（浏览器）通过调用 socket 库来委托协议栈工作。协议栈的上半部分有两块分别是负责收发数据的 TCP 和 UDP 协议，会接收应用层的委托执行收发数据操作。
    - 如果 HTTP 请求信息比较长，超过了 MSS（除去 IP 和 TCP 头部后，一个网络包所能容纳的 TCP 数据的最大长度）的长度，这时 TCP 就需要把 HTTP 的数据拆解成一块块的数据发送，而不是一次性发送所有数据。
- 组装好 TCP 报文后，就交给下面的网络层处理。协议栈的下面一半是 IP 协议控制网络包收发操作。
    - IP 中包括 ICMP 协议和 ARP 协议。
        - ICMP 用于告知网络包传送过程中产生的错误以及各种控制信息；控制消息是指网络通不通，主机是否可达，路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据传递起着重要作用。最广泛的应用是 ping 应用程序；
        - ARP 用于根据 IP 地址查询相应的以太网 MAC 地址；
    - IP 下面的网卡驱动程序负责控制网卡硬件。最下面的网卡则负责完成实际的收发操作，也就是对网线中的信号执行发送和接收操作。
- 生成了 IP 头部后，接下来还需要在 IP 头部的前面加上 MAC 头部。不知道对方 MAC 地址，通过 ARP 协议找到路由器的 MAC 地址。
- IP 生成的网络包只是存放在内存中的一串二进制数字信息，没有办法直接发送给对方，因此需要把数字信息转换为电信号，才能在网线上传输。负责执行这一操作的是网卡，要控制网卡需要靠网卡驱动程序。网卡驱动从 IP 模块获取到包后，会将其复制到网卡内的缓存区中，接着会在其开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列。
- 电信号到达网络接口，交换机里的模块进行接收，将电信号转换为数字信号。通过包末尾的 FCS 检验错误，如果没有问题则放到缓冲区。（host 的网卡本身具有 MAC 地址，并通过核对收到的包的接收方 MAC 地址判断是不是发给自己的，如果不是则丢弃。）交换机的接口不核对接收方 MAC 地址，而是直接接收所有包并存放到缓冲区中。和网卡不同，交换机的接口不核对接收方 MAC 地址。将包存入缓冲区后，接下来需要查询这个包的接收方 MAC 地址是否已在 MAC 地址表中有记录了。
    - 交换机的 MAC 地址表主要包含：（1）设备的 MAC 地址；（2）该设备连接在交换机的哪个端口上。如果包的接收方 MAC 地址与表中某一行匹配，根据端口列的信息，就可以通过交换机电路将包发送到相应的端口。
    - 当 MAC 地址表找不到指定的 MAC 地址会怎样？可能是因为具有该地址的设备还没有向交换机发送过包，或者这个设备一段时间没有工作导致地址被从地址表中删除了。这种情况下交换机无法判断应该把包转发到哪个端口，只能将包转发到除了源端口以外的所有端口上，无论该设备在哪个端口都能收到这个包。
- 网络包经过交换机后到达路由器，并被转发到下一个路由器或目标设备。这一步和交换机不同，路由器是基于 IP 设计的，路由器的每个端口都具有 MAC 地址和 IP 地址。交换机是基于以太网设计的，端口不具有 IP 地址。当转发包时，首先路由器端口会接收发给自己的以太网包，然后路由表查询转发目标，再由相应的端口作为发送方将包发送出去。
    - 当电信号到达网线接口部分，路由器中的模块会将电信号转发成数字信号，然后通过包末尾的 FCS 进行错误校验。如果没问题则检查 MAC 头部中的接收方 MAC 地址。如果是发给自己的包就放进接收缓冲区中，否则就丢弃这个包。完成包接收操作后，就会去掉包开头的 MAC 头部。（MAC 头部作用就是将包送达路由器。）接下来，路由器会根据 MAC 头部后方的 IP 头部中的内容进行包的转发操作。

### DNS 用的是 TCP 协议还是 UDP 协议？

- DNS 占用 53 号端口，同时使用 TCP 和 UDP 协议；
- DNS 在区域传输的时候使用 TCP 协议，其他时候使用 UDP 协议；
- TCP 是一种可靠连接，保证了数据的准确性；辅域名服务器会定时（一般 3 小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，会执行一次区域传送，进行数据同步。区域传送使用 TCP 而不是 UDP，因为数据同步传送的数据量比一个请求应答的数据量要多得多；
- 域名解析时使用 UDP 协议：
    - 客户端向 DNS 服务器查询域名，一般返回的内容都不超过 512 字节，用 UDP 传输即可。不用经过三次握手，这样 DNS 服务器负载更低，响应更快。理论上说，客户端也可以指定向 DNS 服务器查询时使用 TCP。但事实上，很多 DNS 服务器进行配置的时候，仅支持 UDP 查询包；

